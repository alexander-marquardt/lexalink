{% load i18n %}

<!-- The form submission does not have an "action" because we use javascript for the form submission -->
<form method=POST id="id-submit-signup-form">

    <div id="id-show_accept_terms_dialog_box" style="display:none;">
        {% blocktrans with app_name as app_name and minimum_registration_age as age %}
        I confirm that I am {{ age }} or older and that I have read and accept the terms and conditions for using {{ app_name }}
        {% endblocktrans %}
    </div>

    <input type=hidden name=login_type value=signup_fields>

    <div class="grid_6 alpha omega cl-login-fields-background">
        <div class="cl-padding-login-fields">

            <table class="center" > <!-- registration table -->

                <tr>
                    <td class="cl-registration-big-prompt-td">{% trans "Register here" %}</td>
                </tr>
                <tr>
                    <td class="cl-registration-small-prompt-td">({% trans "it only takes 30 seconds" %})
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                </tr>
                {{ html_for_signup|safe }}
                <tr>
                    <td></td>
                    <td><input id="id-submit-signup-button" type="submit" value='{% trans " Register me" %}!'>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</form>


<script type="text/javascript">


function handle_location_changes() {
    // function to expand the locations menu as country and region are selected.

    var default_text = new Object();
    default_text['region'] = '{% trans "Select Region" %}';
    default_text['sub_region'] = '{% trans "Select Sub-Region" %}';
    default_text['not_available'] = '{% trans "Not Defined Yet" %}';
    var id_prefix = "#id-signup_fields";

    var country_id = id_prefix + "-country";
    var region_id = id_prefix + "-region";
    var sub_region_id = id_prefix + "-sub_region";

    $("#id-signup_fields-region").hide();
    $("#id-signup_fields-sub_region").hide();


    load_location_settings_on_change(id_prefix, default_text, true, "{{ live_static_dir }}")
}




function handle_user_registration_form() {

    try {
        $("#id-submit-signup-form").submit(function(e) {

            // prevent double clicks from being processed.
            $('#id-submit-signup-button').attr('disabled', 'disabled');

            clear_both_registration_and_login_fields_errors();

            var submit_signup_form_url = "/rs/process_registration/currently_displayed_url=" + window.location.pathname + "/";
            $(this).ajaxSubmit({
                url: submit_signup_form_url,
                type: 'post',
                dataType: "json",
                clearForm: false,
                cache: false,
                success:  function(post_response) {
                    $('#id-submit-signup-button').removeAttr('disabled'); // enable submit button

                    if ("Registration_OK" in post_response) {
                        // re-direct to the current page that the user is viewing, but this time they will be shown the
                        // verification dialog box, which they can enter their "verification_code" in order to activate
                        // t heir account.
                        var registration_ok_dict = post_response["Registration_OK"];
                        self.location = window.location.pathname + "?show_verification=true&verification_username="+ registration_ok_dict['username'] +
                        "&verification_email=" + registration_ok_dict['verification_email'];

                    } else if ("Registration_Error" in post_response) {
                        registration_errors_dict = post_response["Registration_Error"];
                        show_fields_errors("signup_fields", registration_errors_dict, '');

                    } else {
                        var readable_object = JSON.stringify(post_response);
                        var error_html = "handle_user_registration_form - unknown json response: " + readable_object;
                        report_ajax_error("NA", "NA",  error_html);
                        show_fields_errors("signup_fields", [], error_html);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $('#id-submit-signup-button').removeAttr('disabled'); // enable submit button
                    
                    var error_html;
                    if (jqXHR.responseText != undefined) {
                        error_html = jqXHR.responseText;
                    } else {
                        error_html = "handle_user_registration_form - unknown error";
                    }
                    show_fields_errors("login_fields", [], error_html);
                    report_ajax_error(textStatus, errorThrown, error_html);                       
                }
            });
            // prevent normal page navigation upon form submission - this is the same as calling
            // e.preventDefault and e.stopPropagation
            return false;
        });
    } catch(err) {
        report_try_catch_error( err, "handle_verification_code_input");
    }
}

    
$(document).ready(function() {
    handle_location_changes();
    handle_user_registration_form();
});


</script>

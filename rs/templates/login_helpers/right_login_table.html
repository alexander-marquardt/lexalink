{% load i18n %}
<!--
################################################################################
# LexaLink Copyright information - do not remove this copyright notice
# Copyright (C) 2012
#
# Lexalink - a free social network and dating platform for the Google App Engine.
#
# Original author: Alexander Marquardt
# Documentation and additional information: http://www.LexaLink.com
# Git source code repository: https://github.com/lexalink/LexaLink.git
#
# Please consider contributing your enhancements and modifications to the LexaLink community,
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
################################################################################
-->

<div id="id-show_after_registration_dialog_box" style="display:none;"></div>

    <!-- The form submission does not have an "action" because we use javascript for the form submission -->
    <form method=POST id="id-submit-signup-form">

        <div id="id-show_accept_terms_dialog_box" style="display:none;">
            {% blocktrans with app_name as app_name and minimum_registration_age as age %}
            I confirm that I am {{ age }} or older and that I have read and accept the terms and conditions for using {{ app_name }}
            {% endblocktrans %}
        </div>

        <input type=hidden name=login_type value=signup_fields>
        <input type=hidden id="id-signup_fields-password_hashed" name=password_hashed value="replace_this">

        <div class="grid_6 alpha omega cl-login-fields-background">
            <div class="cl-padding-login-fields">

                <table class="center" > <!-- inner table -->

                    <tr>
                        <td class="cl-registration-big-prompt-td">{% trans "Register here" %}</td>
                    </tr>
                    <tr>
                        <td class="cl-registration-small-prompt-td">({% trans "it only takes 30 seconds" %})
                        </td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                    {{ html_for_signup|safe }}
                    <tr>
                        <td></td>
                        <td><input type="submit" value='{% trans " Register me" %}!'>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- end outer table -->
    </form>



<script type="text/javascript">


    function handle_location_changes() {
        // function to expand the locations menu as country and region are selected.
        
        var default_text = new Object();
        default_text['region'] = '{% trans "Select Region" %}';
        default_text['sub_region'] = '{% trans "Select Sub-Region" %}';
        default_text['not_available'] = '{% trans "Not Defined Yet" %}';
        var id_prefix = "#id-signup_fields";

        var country_id = id_prefix + "-country";
        var region_id = id_prefix + "-region";
        var sub_region_id = id_prefix + "-sub_region";

        $("#id-signup_fields-region").hide();
        $("#id-signup_fields-sub_region").hide();


        // If previous posted values are available for the location, then load the appropriate drop-down menus and set
        // the values to reflect previous selection
        if ($('#id-hidden_country').val()) {

            // load options available for the region
            load_selector_options(region_id, $('#id-hidden_country').val(), default_text['region'], true, $('#id-hidden_region').val(),
                    default_text['not_available'], "{{ live_static_dir }}", "/rs/ajax/get_location_options/");

            // if the region value is defined and is set to "----", then this indicates that the
            // region has not been selected -- therefore don't display the sub_region
            // if it is defined and not "----", then it should be displayed
            if ($('#id-hidden_region').val() && $('#id-hidden_region').val() != "----") {
                load_selector_options(sub_region_id, $('#id-hidden_region').val(), default_text['sub_region'], true, $('#id-hidden_sub_region').val(),
                        default_text['not_available'], "{{ live_static_dir }}", "/rs/ajax/get_location_options/");

            }
        }
        load_location_settings_on_change(id_prefix, default_text, true, "{{ live_static_dir }}")
    }


    function handle_user_registration_form() {


        // The following code automatically submits the file that is selected by the user
        // as opposed to adding a "submit" button. This is more consistent with the other
        // interfaces on the website, and makes more sense.
        $("#id-submit-signup-form").submit(function(e) {

            var submit_signup_form_url = "{% url login.process_registration %}";
            $(this).ajaxSubmit({url: submit_signup_form_url,
                type: 'post',
                dataType: "json",
                clearForm: false,
                cache: false,
                success:  function(post_response) {
                    if ("Registration_OK" in post_response) {
                        $('#id-show_after_registration_dialog_box').html(post_response["Registration_OK"]);
                        $('#id-show_after_registration_dialog_box').dialog();
                    } else if ("Registration_Error" in post_response) {
debugger;
                    } else {
                        var readable_object = JSON.stringify(post_response);
                        report_ajax_error(textStatus, errorThrown, "handle_user_registration_form - unknown json response: " + readable_object);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    if (jqXHR.responseText != undefined) {
                        error_string = jqXHR.responseText;
                    } else {
                        report_ajax_error(textStatus, errorThrown, "handle_user_registration_form - unknown error");
                    }
                }
            });
            // prevent normal page navigation upon form submission - this is the same as calling
            // e.preventDefault and e.stopPropagation
            return false;
        });
    }

    
    $(document).ready(function() {
        handle_location_changes();
        handle_user_registration_form();
    });


</script>

{% load i18n %}
<!--
################################################################################
# LexaLink Copyright information - do not remove this copyright notice
# Copyright (C) 2012
#
# Lexalink - a free social network and dating platform for the Google App Engine.
#
# Original author: Alexander Marquardt
# Documentation and additional information: http://www.LexaLink.com
# Git source code repository: https://github.com/lexalink/LexaLink.git
#
# Please consider contributing your enhancements and modifications to the LexaLink community,
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
################################################################################
-->

<div id="id-show_after_registration_dialog_box" style="display:none;"></div>

    <!-- The form submission does not have an "action" because we use javascript for the form submission -->
    <form method=POST id="id-submit-signup-form">

        <div id="id-show_accept_terms_dialog_box" style="display:none;">
            {% blocktrans with app_name as app_name and minimum_registration_age as age %}
            I confirm that I am {{ age }} or older and that I have read and accept the terms and conditions for using {{ app_name }}
            {% endblocktrans %}
        </div>

        <input type=hidden name=login_type value=signup_fields>

        <div class="grid_6 alpha omega cl-login-fields-background">
            <div class="cl-padding-login-fields">

                <table class="center" > <!-- inner table -->

                    <tr>
                        <td class="cl-registration-big-prompt-td">{% trans "Register here" %}</td>
                    </tr>
                    <tr>
                        <td class="cl-registration-small-prompt-td">({% trans "it only takes 30 seconds" %})
                        </td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                    {{ html_for_signup|safe }}
                    <tr>
                        <td></td>
                        <td><input id="id-submit-signup-button" type="submit" value='{% trans " Register me" %}!'>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- end outer table -->
    </form>



<script type="text/javascript">


    function handle_location_changes() {
        // function to expand the locations menu as country and region are selected.
        
        var default_text = new Object();
        default_text['region'] = '{% trans "Select Region" %}';
        default_text['sub_region'] = '{% trans "Select Sub-Region" %}';
        default_text['not_available'] = '{% trans "Not Defined Yet" %}';
        var id_prefix = "#id-signup_fields";

        var country_id = id_prefix + "-country";
        var region_id = id_prefix + "-region";
        var sub_region_id = id_prefix + "-sub_region";

        $("#id-signup_fields-region").hide();
        $("#id-signup_fields-sub_region").hide();


        load_location_settings_on_change(id_prefix, default_text, true, "{{ live_static_dir }}")
    }


    function clear_registration_errors(registration_errors_dict) {
        for (key in registration_errors_dict) {
            var input_field_id_selector = "#id-signup_fields-" + key;
            $(input_field_id_selector).removeClass("cl-highlight_border");
        }
    }

    function show_registration_errors(registration_errors_dict) {
        
        // loop over the objects in the errors_dict
        var error_html = '<ul>';
        for (key in registration_errors_dict) {
            var input_field_id_selector = "#id-signup_fields-" + key;
            $(input_field_id_selector).addClass("cl-highlight_border");
            error_html += '<li class="cl-indent">'+ registration_errors_dict[key];
        }
        error_html += '</ul>';
        $('#id-show_after_registration_dialog_box').html(error_html);
        $('#id-show_after_registration_dialog_box').dialog({
            width: 400,
            modal: false,
            position: {
                my: "center",
                at: "center",
                of: "#id-over-image"
            }
        }).dialog('close').dialog('open');
    }



    function handle_user_registration_form() {


        // The following code automatically submits the file that is selected by the user
        // as opposed to adding a "submit" button. This is more consistent with the other
        // interfaces on the website, and makes more sense.
        var registration_errors_dict = [];

        $("#id-submit-signup-form").submit(function(e) {

            // prevent double clicks from being processed.
            $('#id-submit-signup-button').attr('disabled', 'disabled')

            clear_registration_errors(registration_errors_dict);

            var submit_signup_form_url = "{% url login.process_registration %}";
            $(this).ajaxSubmit({url: submit_signup_form_url,
                type: 'post',
                dataType: "json",
                clearForm: false,
                cache: false,
                success:  function(post_response) {
                    $('#id-submit-signup-button').removeAttr('disabled'); // enable submit button

                    if ("Registration_OK" in post_response) {
                        $('#id-show_after_registration_dialog_box').html(post_response["Registration_OK"]);
                        $('#id-show_after_registration_dialog_box').dialog({
                            width: 500,
                            modal: true,
                            position: {
                                my: "center",
                                at: "center"
                            }
                        }).dialog('close').dialog('open');
                    } else if ("Registration_Error" in post_response) {
                        registration_errors_dict = post_response["Registration_Error"];
                        show_registration_errors(registration_errors_dict);
                    } else {
                        var readable_object = JSON.stringify(post_response);
                        report_ajax_error(textStatus, errorThrown, "handle_user_registration_form - unknown json response: " + readable_object);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $('#id-submit-signup-button').removeAttr('disabled'); // enable submit button
                    
                    if (jqXHR.responseText != undefined) {
                        error_string = jqXHR.responseText;
                    } else {
                        report_ajax_error(textStatus, errorThrown, "handle_user_registration_form - unknown error");
                    }
                }
            });
            // prevent normal page navigation upon form submission - this is the same as calling
            // e.preventDefault and e.stopPropagation
            return false;
        });
    }

    
    $(document).ready(function() {
        handle_location_changes();
        handle_user_registration_form();
    });


</script>

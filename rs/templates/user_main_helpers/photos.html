{% load i18n %}
<!--
################################################################################
# LexaLink Copyright information - do not remove this copyright notice
# Copyright (C) 2012
#
# Lexalink - a free social network and dating platform for the Google App Engine.
#
# Original author: Alexander Marquardt
# Documentation and additional information: http://www.LexaLink.com
# Git source code repository: https://github.com/lexalink/LexaLink.git
#
# Please consider contributing your enhancements and modifications to the LexaLink community,
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
################################################################################
-->

{% if primary_user_profile_data_fields.is_primary_user %}
<!-- only primary user can upload photos to their account - otherwise, we are displaying photos
     for other clients in the system -->


<script type="text/javascript">


    function handle_photo_upload_form() {


        // The following code automatically submits the file that is selected by the user
        // as opposed to adding a "submit" button. This is more consistent with the other
        // interfaces on the website, and makes more sense.
        $('#id-photo_upload-file').change(function() {

            $("#id-photo_upload-form-wrapper").hide();
            $("#id-show-ajax-loader").show();
            // Get the new submission URL
            var json_path = "/rs/ajax/load_photo_upload_form_url/" + rnd() + "/";
            $.getJSON(json_path,
                    function(json_data) {
                        var blobstore_submit_url = json_data['blobstore_submit_url'];

                        //setup_ajaxForm();
                        //$("#id-photo_upload-form").submit();


                        $('form#id-photo_upload-form').ajaxSubmit({url: blobstore_submit_url,
                            type: 'post',
                            clearForm: true,
                            cache: false,
                            success:  function(post_response) {
                                // write the returned html into the photo table
                                $('#id-photo-table-for-ajax-load').html(post_response);
                                $('#id-photo-table-for-ajax-load').ready(function () {
                                    // see comments above previous fancybox_setup call
                                    fancybox_setup($("a.cl-fancybox-profile-gallery"));
                                    $("#id-photo_upload-form-wrapper").show();
                                    $("#id-show-ajax-loader").hide();
                                    $("#id-photo_upload-file").attr({value: ''});
                                });
                            }
                        });
                    }
                    );
        });
    }


    $(document).ready(function() {


        // Fancybox hook. Associates fancybox with the profile photos.
        fancybox_setup($("a.cl-fancybox-profile-gallery"));
        handle_photo_upload_form();
        $("#id-show-ajax-loader").hide();


        var submit_button_id = "#id-submit-photo_options";
        $(submit_button_id).click(function() {
            $.ajax({
                type: "POST",
                url: "/rs/store_photo_options/{{ primary_user_profile_data_fields.owner_uid }}/" + rnd() + "/",
                data: $("form#id-photo_options-form").serialize(),
                cache: false,
                success: function () {
                    var load_url = '/rs/ajax/load_photos/' + rnd() + "/";
                    var load_profile_url = '/rs/ajax/load_profile_photo/' + rnd() + "/";

                    $('#id-photo-table-for-ajax-load').load(load_url, function() {
                        fancybox_setup($("a.cl-fancybox-profile-gallery"));
                    });

                    $('#id-profile-photo-table-for-ajax-load').load(load_profile_url, function() {
                        fancybox_setup($("a.cl-fancybox-profile-gallery"));                        
                    });
                    $('#id-edit-photos-submit-data-section').hide();
                }
            });
        });
        mouseover_button_handler($(submit_button_id));
    });
</script>

{% else %}  <!-- not if_primary_user -->

<script type="text/javascript">
    $(document).ready(function() {
        fancybox_setup($("a.cl-fancybox-profile-gallery"));
    });
</script>

{% endif %}

<form method="POST" id="id-photo_options-form">
    <div id="id-photo-table-for-ajax-load">
        {{ html_for_main.photos|safe }}
    </div>
</form>


{% if primary_user_profile_data_fields.is_primary_user %}
<div class="cl-clear"></div>
<div id="id-edit-photos-submit-data-section">

    <div class="cl-clear"></div>
    <div class="grid_2 alpha ">&nbsp;</div>
    <div class="grid_5 omega cl-color-text">


        {% if ADULT_ORIENTED_SITE %}

        <strong>{% trans "Rules:" %}</strong>
        <ul>
            <li>
                {% trans "No nude photos." %}
            <li>
                {% trans "Only authorized people will have access to your private photos." %}
            <li>
                {% trans "Read - command verb" %}
                <a href="{% url views.terms %}">{% trans "Terms and conditions" %}</a>
                {% trans "for the rules of" %} {{ app_name }}.
            <li>
                {% trans "Photos that do not follow the rules will be erased without notification." %}
        </ul>

        {% else %}

        <strong>{% trans "Rules:" %}</strong>
        <ul>
            <li>
                {% trans "No pornographic or nude photos allowed." %}
            <li>
                {% trans "Only authorized people will have access to your private photos." %}
            <li>
                {% trans "Read - command verb" %}
                <a href="{% url views.terms %}">{% trans "Terms and conditions" %}</a>
                {% trans "for the rules of" %} {{ build_name }}.
            <li>
                {% trans "Photos that do not follow the rules will be erased without notification." %}

        </ul>
        
        {% endif %}


    </div>
    <div class="cl-clear"></div>

    <div class="grid_2 alpha ">&nbsp;</div>
    <div class="grid_5 omega" id="id-photo_upload-form-wrapper">
        <!-- Note, the following form does not have an "action" declaration, because submission
             is taken care of by the javascript -->
        <form method="post" id="id-photo_upload-form" enctype="multipart/form-data">
            <p><input type="file" name="Filedata" id="id-photo_upload-file" class="cl-file-input"
                      size=16></p>
        </form>
    </div>

    <div class="grid_5 alpha omega" id="id-show-ajax-loader">
        <img src="/{{ live_static_dir }}/img/small-ajax-loader.gif" align=middle alt=''>
    </div>


    <div class="grid_2 alpha omega">&nbsp;</div>
    <div class="grid_2 alpha omega">
        <input type=button class="cl-submit" id="id-submit-photo_options" alt="" value='{% trans "Save changes" %}'>
        <br><br>
    </div>

    <div class="cl-clear"></div>

</div> <!-- "id-edit-photos-submit-data-section" -->
{% endif %}
